# licence https://github.com/vfxwiki/nukeArtistToolkit/blob/master/
#credit for the inverseOver maths  (1/(-1*InOv))*(BG-InOv) ) and idea of using it for keying goes to Thomas Dyn (credit retained in node)/ Although since discovering this someone else have also shown me this same technique from thier toolbox used on a show over before 2000AD - they called it the 'holy matte' trick.
set cut_paste_input [stack 0]
version 7.0 v6
push $cut_paste_input
Group {
 name InverseOKeyer
 label "\n"
 selected true
 xpos 13530
 ypos -7684
 addUserKnob {20 InverseOverKeyer l "Inverse Over Keyer"}
 addUserKnob {26 textArea l "1) select screen area  "}
 addUserKnob {41 cropScreen l "crop screen" T MASTER.cropScreen}
 addUserKnob {41 frameHold l "frame hold" T MASTER.frameHold}
 addUserKnob {22 pySetFrame l " set this frame " -STARTLINE T "f=nuke.frame()\ng=nuke.thisNode()\ng.knob('frameHold').setValue(f)"}
 addUserKnob {26 text02 l "2) match bars setup   "}
 addUserKnob {41 setupMode l "setup mode" T MASTER.setupMode}
 addUserKnob {41 KeyDensity l "key density" T MASTER.KeyDensity}
 addUserKnob {26 ""}
 addUserKnob {26 test02 l fixMatteBlacks: T " "}
 addUserKnob {41 fixMatteBlacks l "" -STARTLINE T MASTER.fixMatteBlacks}
 addUserKnob {41 fixInfNans T MASTER.fixInfNans}
 addUserKnob {26 ""}
 addUserKnob {41 maskChannel l "mask channel" T Keymix2.maskChannel}
 addUserKnob {41 invertMask l invert -STARTLINE T Keymix2.invertMask}
 addUserKnob {20 notes}
 addUserKnob {26 text04_1 l notes: T "beta v0.5b vfxwiki.org\n\nInstructions: \n\nThis is not a keyer, its is a a different way of using an over \nand the reverse of an over (the InverseOver) together to\nmaintain fine transparent detail from mattes.\n\n1) plug in plate despill.\n2) plug in a very thin matte i.e. an unscale'd color difference key. \n3) plug in the bg into the InverseOver.\n4) split the out of the InverseOKeyer into the inverseOver and a premult node.\n5) over the premult and the InverseOver.\n6) follow the instructions on the main tab.\n\nhttp://vfxwiki.org/tiki-index.php?page=Inverse+Over"}
 addUserKnob {26 credit l "" +STARTLINE +INVISIBLE T "The idea of using this for keying and the name goes to Thomas Dyn (credit retained in node please)\n\nAlthough since discovering this technique someone else have also shown me this same technique from thier toolbox used in shake(pre-nuke) - they called it the 'holy matte' trick."}
}
 BackdropNode {
  inputs 0
  name BackdropNode2
  tile_color 0x71c67100
  label key
  note_font_size 42
  xpos -508
  ypos -804
  bdwidth 2948
  bdheight 2860
 }
 Input {
  inputs 0
  name matte
  xpos 675
  ypos -928
 }
 Clamp {
  channels rgb
  minimum {{MASTER.fixInfNans}}
  name Clamp5
  xpos 675
  ypos -626
 }
 Dot {
  name Dot22
  xpos 703
  ypos -433
 }
set N6e9d130 [stack 0]
 Dot {
  name Dot13
  xpos 893
  ypos -433
 }
set N1fd95b0 [stack 0]
 FrameHold {
  first_frame {{FrameHold.first_frame}}
  name FrameHold1
  xpos 859
  ypos -187
 }
 Crop {
  box {{parent.Crop1.box} {parent.Crop1.box} {parent.Crop1.box} {parent.Crop1.box}}
  reformat true
  crop false
  name Crop4
  xpos 859
  ypos -139
 }
 Blur {
  channels rgba
  size 100
  filter box
  name Blur2
  xpos 859
  ypos -71
 }
 Crop {
  box {{int(width/2)} {int(height/2)} {int(width/2)+1} {int(height/2)+1}}
  reformat true
  crop false
  name Crop5
  xpos 859
  ypos -17
 }
push $N1fd95b0
 Dot {
  name Dot11
  xpos 997
  ypos -433
 }
 Dot {
  name Dot8
  xpos 997
  ypos -216
 }
 Shuffle {
  red black
  green black
  blue black
  alpha black
  name Shuffle3
  label "\[value in]-->\[value out]"
  xpos 969
  ypos -103
 }
 Merge2 {
  inputs 2
  bbox B
  name Merge8
  xpos 969
  ypos -17
 }
push $N6e9d130
 Dot {
  name Dot44
  xpos 703
  ypos -238
 }
set Nb368d8a0 [stack 0]
 Dot {
  name Dot16
  xpos 703
  ypos -26
 }
 Dot {
  name Dot4
  xpos 676
  ypos -26
 }
set N1d987b0 [stack 0]
 Dot {
  name Dot3
  xpos 566
  ypos -26
 }
set N377bea10 [stack 0]
 FrameHold {
  first_frame {{MASTER.frameHold}}
  name FrameHold3
  xpos 532
  ypos 52
 }
 Crop {
  box {{parent.MASTER.cropScreen} {parent.MASTER.cropScreen} {parent.MASTER.cropScreen} {parent.MASTER.cropScreen}}
  name Crop7
  xpos 532
  ypos 112
 }
 Blur {
  channels rgba
  size 100
  filter box
  quality 25
  name Blur4
  xpos 532
  ypos 167
 }
 Crop {
  box {{parent.Crop7.box.x+((parent.Crop7.box.r-parent.Crop7.box.x)*0.5) x1012 -27} {int(parent.Crop7.box.y+((parent.Crop7.box.t-parent.Crop7.box.y)*0.5))} {int(parent.Crop7.box.x+((parent.Crop7.box.r-parent.Crop7.box.x)*0.5)+1)} {int(int(parent.Crop7.box.y+((parent.Crop7.box.t-parent.Crop7.box.y)*0.5)+1))}}
  reformat true
  crop false
  name Crop8
  xpos 532
  ypos 218
 }
 Input {
  inputs 0
  name despill
  xpos 1340
  ypos -938
  number 1
 }
 Shuffle {
  alpha black
  name Shuffle2
  label "\[value in]-->\[value out]"
  xpos 1340
  ypos -684
 }
 Dot {
  name Dot31
  xpos 1364
  ypos -498
 }
 Dot {
  name Dot1
  xpos 1364
  ypos -100
 }
set Neda9af80 [stack 0]
 Dot {
  name Dot10
  xpos 1252
  ypos -100
 }
set Nb6242520 [stack 0]
 Dot {
  name Dot14
  xpos 1129
  ypos -100
 }
 Shuffle {
  red black
  green black
  blue black
  alpha black
  name Shuffle7
  label "\[value in]-->\[value out]"
  xpos 1095
  ypos 273
 }
set N1bb52a0 [stack 0]
 Merge2 {
  inputs 2
  bbox B
  name Merge10
  xpos 532
  ypos 279
 }
set N3d9c60 [stack 0]
push $N3d9c60
push $N1d987b0
 Merge2 {
  inputs 2
  operation min
  name Min2
  xpos 642
  ypos 325
 }
 Merge2 {
  inputs 2
  operation divide
  name Merge2
  xpos 532
  ypos 407
 }
push $N377bea10
 Dot {
  name Dot2
  xpos 464
  ypos -26
 }
 Merge2 {
  inputs 2
  operation multiply
  name Merge9
  xpos 430
  ypos 450
  disable {{!MASTER.fixMatteBlacks}}
 }
 Grade {
  channels alpha
  gamma {{parent.MASTER.KeyDensity x1002 1.26}}
  black_clamp false
  name GradeDensity
  xpos 430
  ypos 684
 }
 Shuffle {
  red alpha
  green alpha
  blue alpha
  name Shuffle9
  xpos 430
  ypos 752
 }
set N1fa6a00 [stack 0]
 Dot {
  name Dot9
  xpos 865
  ypos 755
 }
set N4eefbc0 [stack 0]
 Dot {
  name Dot12
  xpos 1090
  ypos 755
 }
push $Nb6242520
 FrameHold {
  first_frame {{FrameHold.first_frame}}
  name FrameHold2
  xpos 1218
  ypos 452
 }
 Crop {
  box {{parent.Crop1.box} {parent.Crop1.box} {parent.Crop1.box} {parent.Crop1.box}}
  reformat true
  crop false
  name Crop2
  xpos 1218
  ypos 500
 }
 Blur {
  channels rgba
  size 100
  filter box
  name Blur1
  xpos 1218
  ypos 568
 }
 Crop {
  box {{int(width/2)} {int(height/2)} {int(width/2)+1} {int(height/2)+1}}
  reformat true
  crop false
  name Crop6
  xpos 1218
  ypos 622
 }
push $Neda9af80
 Dot {
  name Dot20
  xpos 1364
  ypos 417
 }
set N1bcfdb0 [stack 0]
 Shuffle {
  red black
  green black
  blue black
  alpha black
  name Shuffle6
  label "\[value in]-->\[value out]"
  xpos 1328
  ypos 537
 }
 Merge2 {
  inputs 2
  bbox B
  name Merge3
  xpos 1328
  ypos 622
 }
 Copy {
  inputs 2
  from0 rgba.alpha
  to0 rgba.alpha
  from1 -rgba.alpha
  to1 -rgba.blue
  name Copy1
  xpos 1328
  ypos 746
 }
set N4e4030 [stack 0]
 Dot {
  name Dot21
  xpos 1544
  ypos 755
 }
 Input {
  inputs 0
  name mask
  xpos -154
  ypos -747
  number 2
 }
 Clamp {
  name Clamp7
  xpos -154
  ypos -721
 }
 Invert {
  name Invert3
  xpos -154
  ypos -683
 }
 Dot {
  name Dot15
  xpos -120
  ypos 1892
 }
push $Nb368d8a0
 Dot {
  name Dot6
  xpos 330
  ypos -238
 }
 Shuffle {
  red black
  green black
  blue black
  alpha black
  name Shuffle1
  xpos 296
  ypos 1546
 }
 Grid {
  number {6 0}
  size {{width/2/number}}
  color {0.5 0.5 0.5 1}
  name Grid2
  xpos 296
  ypos 1605
 }
push $N4eefbc0
 Shuffle {
  red alpha
  green alpha
  blue alpha
  name Shuffle13
  label "\[value in]-->\[value out]"
  xpos 844
  ypos 1545
 }
 Merge2 {
  inputs 2
  name Merge1
  label "Density match"
  xpos 844
  ypos 1599
 }
push $N1bcfdb0
 Dot {
  name Dot19
  xpos 1495
  ypos 417
 }
 Dot {
  name Dot18
  xpos 1495
  ypos 1206
 }
push $N1fa6a00
 FrameHold {
  first_frame {{MASTER.frameHold}}
  name FrameHold
  xpos 428
  ypos 804
 }
 Crop {
  box {{parent.MASTER.cropScreen} {parent.MASTER.cropScreen} {parent.MASTER.cropScreen} {parent.MASTER.cropScreen}}
  name Crop1
  xpos 428
  ypos 855
 }
 Blur {
  channels rgba
  size 100
  filter box
  quality 25
  name Blur3
  xpos 428
  ypos 897
 }
 Crop {
  box {{parent.Crop1.box.x+((parent.Crop1.box.r-parent.Crop1.box.x)*0.5) x1012 -27} {int(parent.Crop1.box.y+((parent.Crop1.box.t-parent.Crop1.box.y)*0.5))} {int(parent.Crop1.box.x+((parent.Crop1.box.r-parent.Crop1.box.x)*0.5)+1)} {int(int(parent.Crop1.box.y+((parent.Crop1.box.t-parent.Crop1.box.y)*0.5)+1))}}
  reformat true
  crop false
  name Crop3
  xpos 428
  ypos 938
 }
 Dot {
  name Dot17
  xpos 462
  ypos 1087
 }
push $N1bb52a0
 Merge2 {
  inputs 2
  bbox B
  name Merge4
  xpos 1095
  ypos 1094
 }
push $N4e4030
add_layer {inverseOver inverseOver.red inverseOver.green inverseOver.blue inverseOver.alpha}
 Shuffle {
  out inverseOver
  name Shuffle5
  label "\[value in]-->\[value out]"
  xpos 1328
  ypos 1040
 }
 Copy {
  inputs 2
  from0 rgba.alpha
  to0 inverseOver.alpha
  name Copy3
  xpos 1328
  ypos 1088
 }
 Copy {
  inputs 2
  from0 rgba.red
  to0 rgba.red
  from1 rgba.green
  to1 rgba.green
  from2 rgba.blue
  to2 rgba.blue
  name Copy2
  xpos 1328
  ypos 1185
 }
 Clamp {
  channels rgba
  MinClampTo_enable true
  name Clamp9
  xpos 1328
  ypos 1477
  disable true
 }
 Switch {
  inputs 2
  which {{MASTER.setupMode x1021 0}}
  name Switch1
  xpos 1328
  ypos 1605
 }
set Naa7e76c0 [stack 0]
 Shuffle {
  in inverseOver
  name Shuffle11
  label "\[value in]-->\[value out]"
  xpos 1200
  ypos 1769
 }
 Dot {
  name Dot7
  xpos 1242
  ypos 1847
 }
push $Naa7e76c0
 Keymix {
  inputs 3
  channels rgba
  maskChannel -rgba.alpha
  invertMask true
  name Keymix2
  xpos 1328
  ypos 1889
  disable {{maskChannel?none:1 x1013 1}}
 }
 Output {
  name Output2
  xpos 1328
  ypos 2156
 }
 NoOp {
  inputs 0
  name MASTER
  selected true
  xpos 1762
  ypos 1601
  addUserKnob {20 User}
  addUserKnob {26 ""}
  addUserKnob {15 cropScreen l "crop screen"}
  cropScreen {2194 1254 2812 2017}
  addUserKnob {3 frameHold l "frame hold"}
  frameHold 1044
  addUserKnob {26 ""}
  addUserKnob {4 setupMode l "setup mode" M {off "key density" ""}}
  addUserKnob {7 KeyDensity l "key density" R 0.01 1}
  KeyDensity 0.672
  addUserKnob {26 ""}
  addUserKnob {26 test02 l fixMatteBlacks: T " "}
  addUserKnob {6 fixMatteBlacks l "" -STARTLINE}
  addUserKnob {7 fixInfNans R 0 0.01}
 }
end_group
Group {
 name InverseOver
 selected true
 xpos 13725
 ypos -7684
 addUserKnob {20 inverseOver l "Inverse Over"}
 addUserKnob {41 in l "invOver input channel" T Shuffle1.in}
 addUserKnob {26 credit l "" +STARTLINE +INVISIBLE T "The idea of using this for keying and the name goes to Thomas Dyn (credit retained in node please)\n\nAlthough since discovering this technique someone else have also shown me this same technique from thier toolbox used in shake(pre-nuke) - they called it the 'holy matte' trick."}
}
 Input {
  inputs 0
  name invOver
  xpos 262
  ypos -73
 }
 Shuffle {
  in inverseOver
  name Shuffle1
  label "\[value in]-->\[value out]"
  xpos 262
  ypos -12
 }
 Premult {
  name Premult1
  xpos 262
  ypos 68
 }
set N1bb0530 [stack 0]
 Invert {
  name Invert1
  xpos 262
  ypos 99
 }
set N22d4270 [stack 0]
 Shuffle {
  red white
  green white
  blue white
  alpha white
  name Shuffle2
  label "\[value in]-->\[value out]"
  xpos 152
  ypos 99
 }
 Dot {
  name Dot1
  xpos 197
  ypos 199
 }
push $N22d4270
 Merge2 {
  inputs 2
  operation divide
  name Merge1
  xpos 255
  ypos 201
 }
 Shuffle {
  red alpha
  green alpha
  blue alpha
  name Shuffle3
  label "\[value in]-->\[value out]"
  selected true
  xpos 255
  ypos 320
 }
 Input {
  inputs 0
  name bg
  xpos 392
  ypos -70
  number 1
 }
set Naa817140 [stack 0]
 Dot {
  name Dot3
  xpos 420
  ypos 186
 }
push $N1bb0530
 Dot {
  name Dot2
  xpos 521
  ypos 71
 }
 Merge2 {
  inputs 2
  operation minus
  bbox A
  name Merge2
  xpos 493
  ypos 188
 }
 Dot {
  name Dot5
  xpos 521
  ypos 276
 }
 Dot {
  name Dot6
  xpos 118
  ypos 276
 }
 Dot {
  name Dot7
  xpos 121
  ypos 433
 }
 Merge2 {
  inputs 2
  operation multiply
  bbox B
  name Merge3
  xpos 255
  ypos 435
 }
 Remove {
  channels inverseOver
  name Remove1
  xpos 255
  ypos 487
 }
push $Naa817140
 Dot {
  name Dot4
  xpos 691
  ypos -72
 }
 Copy {
  inputs 2
  from0 rgba.red
  to0 rgba.red
  from1 rgba.green
  to1 rgba.green
  from2 rgba.blue
  to2 rgba.blue
  channels all
  bbox B
  name Copy1
  xpos 649
  ypos 461
 }
 Output {
  name Output1
  xpos 649
  ypos 661
 }
 Output {
  name Output2
  xpos 649
  ypos 761
 }
end_group
